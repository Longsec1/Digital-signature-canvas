<html>
<body>
  <canvas id="signature-pad" width="300" height="200" style="border:1px solid black;"></canvas>
  <br>
  <label for="pen-color">Pen Color:</label>
  <input type="color" id="pen-color" value="#000000">
  <label for="pen-thickness">Pen Thickness:</label>
  <input type="range" id="pen-thickness" min="1" max="10" value="2">
  <label for="pen-style">Pen Style:</label>
  <select id="pen-style">
    <option value="solid">Solid</option>
    <option value="dotted">Dotted</option>
  </select>
  <br><br>
  <input type="file" id="upload-bg" accept="image/*">
  <label for="upload-bg">Upload Custom Background</label>
  <br><br>
  <button id="clear">Clear</button>
  <button id="undo">Undo</button>
  <button id="redo">Redo</button>
  <button id="save-png">Save as PNG</button>
  <button id="save-jpg">Save as JPG</button>
  <button id="save-pdf">Save as PDF</button>
  <button id="save-svg">Save as SVG</button>
  <br><br>
  <canvas id="preview-canvas" width="300" height="200" style="border:1px solid gray; display: none;"></canvas>
  <br>
  <button id="edit-preview" style="display: none;">Edit Preview</button>
  <br><br>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
  <script>
    var canvas = document.getElementById('signature-pad');
    var signaturePad = new SignaturePad(canvas);
    var previewCanvas = document.getElementById('preview-canvas');
    var ctxPreview = previewCanvas.getContext('2d');
    var undoStack = [];
    var redoStack = [];
    var backgroundImage = null;

    // Pen color change
    document.getElementById('pen-color').addEventListener('input', function () {
      signaturePad.penColor = this.value;
    });

    // Pen thickness change
    document.getElementById('pen-thickness').addEventListener('input', function () {
      var lineWidth = parseInt(this.value);
      signaturePad.minWidth = lineWidth;
      signaturePad.maxWidth = lineWidth;
    });

    // Pen style change
    document.getElementById('pen-style').addEventListener('change', function () {
      if (this.value === 'dotted') {
        canvas.style.border = '1px dotted black';
      } else {
        canvas.style.border = '1px solid black';
      }
    });

    // Clear signature pad
    document.getElementById('clear').addEventListener('click', function () {
      signaturePad.clear();
      undoStack = []; // Clear the undo history
    });

    // Undo feature
    document.getElementById('undo').addEventListener('click', function () {
      if (undoStack.length) {
        redoStack.push(signaturePad.toData());
        var lastState = undoStack.pop();
        signaturePad.fromData(lastState);
      }
    });

    // Redo feature
    document.getElementById('redo').addEventListener('click', function () {
      if (redoStack.length) {
        undoStack.push(signaturePad.toData());
        var nextState = redoStack.pop();
        signaturePad.fromData(nextState);
      }
    });

    // Save as PNG, JPG, PDF, SVG
    document.getElementById('save-png').addEventListener('click', function () {
      saveSignature('png');
    });
    document.getElementById('save-jpg').addEventListener('click', function () {
      saveSignature('jpg');
    });
    document.getElementById('save-pdf').addEventListener('click', function () {
      saveSignature('pdf');
    });
    document.getElementById('save-svg').addEventListener('click', function () {
      saveSignature('svg');
    });

    function saveSignature(format) {
      if (!signaturePad.isEmpty()) {
        var dataURL;
        if (format === 'png' || format === 'jpg') {
          dataURL = signaturePad.toDataURL('image/' + format);
        } else if (format === 'pdf') {
          var imgData = signaturePad.toDataURL('image/png');
          var pdf = new jsPDF();
          pdf.addImage(imgData, 'PNG', 0, 0);
          pdf.save('signature.pdf');
          return;
        } else if (format === 'svg') {
          dataURL = signaturePad.toDataURL('image/svg+xml');
        }

        var link = document.createElement('a');
        link.href = dataURL;
        link.download = `signature.${format}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else {
        alert("Please provide a signature first.");
      }
    }

    // Upload custom background
    document.getElementById('upload-bg').addEventListener('change', function (event) {
      var reader = new FileReader();
      reader.onload = function (e) {
        var img = new Image();
        img.onload = function () {
          canvas.width = img.width;
          canvas.height = img.height;
          var ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          backgroundImage = img; // Store the background image
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(event.target.files[0]);
    });

    // Preview signature
    signaturePad.onEnd = function () {
      var dataURL = signaturePad.toDataURL();
      var image = new Image();
      image.src = dataURL;
      image.onload = function () {
        ctxPreview.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        ctxPreview.drawImage(image, 0, 0);
        previewCanvas.style.display = 'block';
        document.getElementById('edit-preview').style.display = 'inline';
      };
    };

    // Edit signature preview
    document.getElementById('edit-preview').addEventListener('click', function () {
      var imgData = previewCanvas.toDataURL();
      signaturePad.fromDataURL(imgData);
    });

    // Mobile optimization - pinch-to-zoom functionality
    if (/Mobi|Android/i.test(navigator.userAgent)) {
      var lastScale = 1;
      canvas.addEventListener('touchmove', function (event) {
        if (event.touches.length === 2) {
          event.preventDefault();
          var touch1 = event.touches[0];
          var touch2 = event.touches[1];
          var currentScale = Math.hypot(touch2.pageX - touch1.pageX, touch2.pageY - touch1.pageY);
          if (lastScale) {
            var scale = currentScale / lastScale;
            canvas.style.transform = `scale(${scale})`;
          }
          lastScale = currentScale;
        }
      });
    }
  </script>
</body>
  </html>
